<div
    *ngIf="isDashboard == true"
    class="sm:inset-0 flex flex-col flex-auto min-w-0 sm:overflow-hidden bg-card dark:bg-transparent"
>
    <div class="page-title justify-between">
        <span class="text-3xl font-semibold">{{
            "serviceCall.workOrdersDshboard" | translate
        }}</span>
    </div>

    <div class="status-cards">
        <div *ngFor="let status of statusList" class="card">
            <div class="card-content" (click)="getServiceitems(status.value)">
                <img
                    [src]="status.imgPath"
                    alt="{{ status.label }}"
                    class="status-image"
                />

                <div class="content">
                    <div class="count">
                        {{ status?.sCount }}
                    </div>
                    <div class="description">
                        {{  "serviceCall." + status.label | translate }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div
    *ngIf="isDashboard == false"
    class="sm:inset-0 flex flex-col flex-auto min-w-0 sm:overflow-hidden bg-card dark:bg-transparent"
>
    <div>
        <div class="page-title justify-between flex">
            <span class="text-3xl font-semibold">
                {{ "serviceCall.serviceList" | translate }}
            </span>
        </div>

        <div
            class="flex flex-col sm:flex-row flex-0 sm:items-center sm:justify-between pb-4 px-6 md:px-4"
        >
            <div class="absolute inset-x-0 bottom-0" *ngIf="isLoading">
                <mat-progress-bar [mode]="'indeterminate'"></mat-progress-bar>
            </div>
            <div>
                <mat-form-field class="w-full" [subscriptSizing]="'dynamic'">
                    <mat-icon
                        matPrefix
                        [svgIcon]="'heroicons_solid:search'"
                    ></mat-icon>
                    <input
                        matInput
                        [formControl]="searchInputControl"
                        (keyup)="applyFilter($event.target.value)"
                        [autocomplete]="'off'"
                        placeholder="Search"
                    />
                </mat-form-field>
            </div>
            <div class="flex shrink-0 items-center mt-6 sm:mt-0">
                <button
                    mat-flat-button
                    [color]="'primary'"
                    (click)="createServiceCall()"
                >
                    <mat-icon>add</mat-icon>
                    <span class="ml-2 mr-1">
                        {{ "serviceCall.newServiceCall" | translate }}</span
                    >
                </button>
                <button
                    mat-flat-button
                    class="ml-2 mr-1"
                    [color]=""
                    (click)="backToDashboard()"
                >
                    <mat-icon>arrow_back</mat-icon>
                    <span class="ml-2 mr-1">{{ "serviceCall.back" | translate }}</span>
                </button>
            </div>
        </div>

        <div class="flex flex-auto overflow-hidden">
            <div
                class="flex flex-col flex-auto overflow-hidden sm:overflow-y-auto sm:justify-between px-6 md:px-4"
            >
                <table
                    mat-table
                    [dataSource]="dataSource"
                    multiTemplateDataRows
                    class="mat-elevation-z8"
                >
                    <!-- Service Call ID Column -->
                    <ng-container matColumnDef="serviceCallId">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.serviceCallId" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.serviceCallId }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="categoryName">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.categoryName" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.categoryName }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="natureOfFault">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.complaint" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.natureOfFault }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="adminDescription">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.complaintDescription" | translate }}
                        </th>
                        <td
                            mat-cell
                            *matCellDef="let element"
                            [matTooltip]="element.adminDescription"
                            matTooltipPosition="above"
                        >
                            {{ element.adminDescription | slice : 0 : 20
                            }}{{
                                element.adminDescription.length > 20
                                    ? "..."
                                    : ""
                            }}
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="vendorName">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.vendorName" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.vendorName }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="raisedBy">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.raised" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            {{ element.raisedBy }}
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.status" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            <span *ngIf="![20, 30].includes(element.status)">{{
                                getServiceCallStatusLabel(element.status)
                            }}</span>
                            <spn
                                *ngIf="[20, 30].includes(element.status)"
                                matTooltip="{{ element.vendorDescription }}"
                                >{{
                                    getServiceCallStatusLabel(element.status)
                                }}</spn
                            >
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="visitTimeFrom">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.scheduleFrom" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            <div>
                                {{
                                    element.visitTimeFrom | date : "dd/MM/yyyy"
                                }}
                            </div>
                            <div class="text-sm text-disabled">
                                {{
                                    element?.visitTimeFrom | date : "shortTime"
                                }}
                            </div>
                        </td>
                    </ng-container>
                    <ng-container matColumnDef="visitTimeTo">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.scheduleTo" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            <div>
                                {{ element.visitTimeTo | date : "dd/MM/yyyy" }}
                            </div>
                            <div class="text-sm text-disabled">
                                {{ element?.visitTimeTo | date : "shortTime" }}
                            </div>
                        </td>
                    </ng-container>
                    <!-- Actions Column -->
                    <ng-container matColumnDef="action">
                        <th mat-header-cell *matHeaderCellDef>
                            {{ "serviceCall.actions" | translate }}
                        </th>
                        <td mat-cell *matCellDef="let element">
                            <mat-icon [matMenuTriggerFor]="menu">
                                more_vert
                            </mat-icon>

                            <mat-menu #menu="matMenu">
                                <button
                                    mat-menu-item
                                    (click)="onExpand(element)"
                                >
                                    {{
                                        expandedElement === element
                                            ? ('serviceCall.hide' | translate) : ('serviceCall.viewProducts' | translate)                                            
                                    }}
                                </button>
                                <button
                                    *ngIf="element.status == 10"
                                    mat-menu-item
                                    (click)="
                                        updateServiceCall(element.serviceCallId)
                                    "
                                >
                                    {{ "serviceCall.edit" | translate }}
                                </button>
                                <button
                                    *ngIf="element.status == 90"
                                    mat-menu-item
                                    (click)="approveForPayment(element)"
                                >
                                    {{ "serviceCall.approveForPayment" | translate }}
                                </button>
                                <button
                                *ngIf="element.status == 100"
                                mat-menu-item
                                (click)="confirmDeactiveUser(element)"
                            >
                            {{ "serviceCall.sentForPayment" | translate }}
                            </button>

                            </mat-menu>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr
                        mat-row
                        *matRowDef="let row; columns: displayedColumns"
                    ></tr>

                    <!-- Expanded Child Table -->
                    <tr
                        *matRowDef="let row; columns: []"
                        class="inner-row"
                        [style.display]="
                            expandedElement === row ? 'table-row' : 'none'
                        "
                    >
                        <td [attr.colspan]="displayedColumns.length">
                            <table
                                mat-table
                                [dataSource]="childData"
                                class="child-table"
                                *ngIf="expandedElement === row"
                            >
                                <ng-container matColumnDef="productName">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{
                                            "serviceCall.productName"
                                                | translate
                                        }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        {{ child.productName }}
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="quantity">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{ "serviceCall.quantity" | translate }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        {{ child.quantity }}
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="defectImageName">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{
                                            "serviceCall.defectImage"
                                                | translate
                                        }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        <a
                                            *ngIf="child.defectImagePath"
                                            [href]="child.defectImagePath"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                        >
                                            {{ child.defectImageName }}
                                        </a>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="repairedImageName">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{
                                            "serviceCall.repairedImage"
                                                | translate
                                        }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        <a
                                            *ngIf="child.repairedImagePath"
                                            [href]="child.repairedImagePath"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                        >
                                            {{ child.repairedImageName }}
                                        </a>
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="estimatedAmount">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{
                                            "serviceCall.estimatedAmount"
                                                | translate
                                        }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        {{ child.estimatedAmount }}
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{
                                            "serviceCall.productStatus"
                                                | translate
                                        }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        {{
                                            getStatusLabel(child.productStatus)
                                        }}
                                    </td>
                                </ng-container>
                                <ng-container matColumnDef="action">
                                    <th mat-header-cell *matHeaderCellDef>
                                        {{ "serviceCall.actions" | translate }}
                                    </th>
                                    <td mat-cell *matCellDef="let child">
                                        <mat-icon [matMenuTriggerFor]="menu"  *ngIf="
                                        child.productStatus == 20
                                    " >
                                            more_vert
                                        </mat-icon>

                                        <mat-menu #menu="matMenu">
                                            <button
                                                *ngIf="
                                                    child.productStatus == 20
                                                "
                                                mat-menu-item
                                                (click)="
                                                    approveOrRejectEstimation(
                                                        child.serviceCallId,child.productId,30
                                                    )
                                                "
                                            >
                                                Approve
                                            </button>
                                            <button
                                            *ngIf="child.productStatus == 20"
                                            color="warn"
                                            mat-menu-item
                                            (click)="
                                                approveOrRejectEstimation(
                                                    child.serviceCallId,child.productId,40
                                                )
                                            "
                                        >
                                            Deny
                                        </button>
                                        </mat-menu>
                                    </td>
                                </ng-container>
                                <tr
                                    mat-header-row
                                    *matHeaderRowDef="[
                                        'productName',
                                        'quantity',
                                        'defectImageName',
                                        'repairedImageName',
                                        'estimatedAmount',
                                        'status',
                                        'action'
                                    ]"
                                ></tr>
                                <tr
                                    mat-row
                                    *matRowDef="
                                        let child;
                                        columns: [
                                            'productName',
                                            'quantity',
                                            'defectImageName',
                                            'repairedImageName',
                                            'estimatedAmount',
                                            'status',
                                            'action'
                                        ]
                                    "
                                ></tr>
                            </table>
                        </td>
                    </tr>
                </table>
                <mat-paginator
                    [pageSizeOptions]="[5, 10, 25, 100]"
                    showFirstLastButtons
                ></mat-paginator>
            </div>
        </div>
    </div>
</div>
<div>
    <ng-template #roleInfoDialog>
        <mat-dialog-content class="dialog-content">
            <h1>
                {{ "serviceCall.approvePayMsg" | translate }}
                <!-- <span class="highlight">{{ statusSelected }}</span
                >? -->
            </h1>

            <mat-form-field appearance="fill" style="margin-top: 25px">
                <mat-label> {{ "serviceCall.reason" | translate }}</mat-label>
                <input
                    matInput
                    [formControl]="reasonControl"
                    placeholder="Enter reason"
                />
            </mat-form-field>

            <div style="display: flex; justify-content: flex-end">
                <button mat-button matDialogClose (click)="onClose()">
                    {{ "serviceCall.cancel" | translate }}
                </button>
                <button
                    mat-flat-button
                    color="primary"
                    (click)="confirmChange()"
                >
                    {{ "serviceCall.update" | translate }}
                </button>
            </div>
        </mat-dialog-content>
    </ng-template>
</div>
